
\RequirePackage{collectbox}
\providecommand\adjbox@setdim{\setlength}


% LaTeX core

\newcommand*{\Makebox}{%
    \collectboxcheckenv{Makebox}%
    \@ifnextchar[%
        \@Makebox
        \mbox
}


\def\@Makebox[#1]{%
    \@ifnextchar[%
        {\@iMakebox{#1}}%
        {\@iMakebox{#1}[c]}%
}


\def\@iMakebox#1[#2]{%
    \@collectbox{%
        \let\@tempboxa\collectedbox
        \adjbox@setdim\@tempdima{#1}%
        \hb@xt@\@tempdima{\csname bm@#2\endcsname}%
    }%
}


\newcommand*\Fbox{%
    \collectbox@{\kern\fboxsep}{\let\@tempboxa\collectedbox\@frameb@x\relax}{\kern\fboxsep}%
}


\newcommand*\Mbox{%
    \leavevmode
    \@ifnextchar\bgroup
        \hbox
        \mbox
}



\newcommand*\Raisebox[1]{%
    \leavevmode
    \collectboxcheckenv{Raisebox}%
    \@ifnextchar[%
        {\@Rsbox{#1}}%
        {\@collectbox{\@iRsbox{#1}{}}}%
}

\def\@Rsbox#1[#2]{%
    \@ifnextchar[%
        {\@iiRsbox{#1}{#2}}%
        {\@collectbox{\@iRsbox{#1}{#2}}}%
}

\def\@iRsbox#1#2{%
    \adjbox@setdim\@tempdima{#1}%
    \ifx \\#2\\\else
        \adjbox@setdim\@tempdimb{#2}%
    \fi
    \setbox\collectedbox\hbox{\raise\@tempdima\box\collectedbox}%
    \ifx \\#2\\\else
        \ht\collectedbox\@tempdimb
    \fi
    \box\collectedbox
}

\def\@iiRsbox#1#2[#3]{%
    \@collectbox{\@iiiRsbox{#1}{#2}{#3}}%
}

\def\@iiiRsbox#1#2#3{%
    \adjbox@setdim\@tempdima{#1}%
    \adjbox@setdim\@tempdimb{#2}%
    \adjbox@setdim\dimen@{#3}%
    \setbox\collectedbox\hbox{\raise\@tempdima\box\collectedbox}%
    \ht\collectedbox\@tempdimb
    \dp\collectedbox\dimen@
    \box\collectedbox
}


\newcommand*\Leftline{\nocollectbox@to\linewidth{}{}\hss}
\newcommand*\Rightline{\nocollectbox@to\linewidth\hss{}{}}
\newcommand*\Centerline{\nocollectbox@to\linewidth\hss{}\hss}
\newcommand*\Rlap{\nocollectbox@to\z@{}{}\hss}
\newcommand*\Llap{\nocollectbox@to\z@\hss{}{}}


\newcommand*\Framebox{%
    \collectboxcheckenv{Framebox}%
    \@ifnextchar[%
        \@Framebox
        \Fbox
}


\def\@Framebox[#1]{%
  \@ifnextchar[%
    {\@iFramebox{#1}}%
    {\@iFramebox{#1}[c]}%
}


\def\@iFramebox#1[#2]{%
    \@collectbox{\@iiFramebox{#1}{#2}}%
}

\def\@iiFramebox#1#2{%
    \let\@tempboxa\collectedbox
    \adjbox@setdim\@tempdima{#1}%
    \setbox\@tempboxa\hb@xt@\@tempdima
         {\kern\fboxsep\csname bm@#2\endcsname\kern\fboxsep}%
    \@frameb@x{\kern-\fboxrule}%
}


\newcommand\Parbox{%
  \collectboxcheckenv{Parbox}%
  \@ifnextchar[%
    \@iParbox
    {\@iiiParbox c\relax[s]}%
}

\def\@iParbox[#1]{%
  \@ifnextchar[%
    {\@iiParbox{#1}}%
    {\@iiiParbox{#1}\relax[s]}%
}

\def\@iiParbox#1[#2]{%
  \@ifnextchar[%
    {\@iiiParbox{#1}{#2}}%
    {\@iiiParbox{#1}{#2}[#1]}%
}

\def\@iiiParbox#1#2[#3]#4{%
  \leavevmode
  \begingroup
  \@pboxswfalse
  \setlength\@tempdima{#4}%
  \let\collect@box\vbox
  \let\@tempboxa\collectedbox
  \collectbox@{\hsize\@tempdima\@parboxrestore}{\@vParbox{#1}{#2}{#3}}{\@@par}%
}


\newcommand*\Sbox[1]{\@collectboxto{#1}{}}

\def\Savebox#1{%
  \@ifnextchar[%
    {\@savebox#1}%
    {\Sbox#1}%
}


\def\@Savebox#1[#2]{%
  \@ifnextchar [%
    {\@iSavebox#1{#2}}%
    {\@iSavebox#1{#2}[c]}%
}

\def\@iSavebox#1#2[#3]{%
    \@collectboxto#1{\@iiSavebox{#1}{#2}{#3}}%
}

\def\@iiSavebox#1#2#3{%
    \sbox#1{%
        \let\@tempboxa\collectedbox
        \adjbox@setdim\@tempdima{#2}%
        \hb@xt@\@tempdima{\csname bm@#3\endcsname}%
    }%
}

%%% color
\RequirePackage{color}

\newcommand*\Colorbox{}%
\def\Colorbox#1#{%
    \collectboxcheckenv{Colorbox}%
    \Color@box{#1}%
}
\def\Color@box#1#2{%
    \@collectbox{\color@box{#1}{#2}\BOXCONTENT}%
}

\newcommand*\Fcolorbox{}
\def\Fcolorbox#1#{%
    \collectboxcheckenv{Fcolorbox}%
    \Color@fbox{#1}%
}
\def\Color@fbox#1#2#3#{%
    \Color@@fbox{#1}{#2}{#3}%
}
\def\Color@@fbox#1#2#3#4{%
    \protect\@collectbox{\protect\color@fb@x{#1}{#2}{#3}{#4}\BOXCONTENT}%
}

%%% graphicx
\RequirePackage{graphicx}
\newcommand*\Rotatebox{%
    \collectboxcheckenv{Rotatebox}%
    \@ifnextchar[%
        \Rotatebox@kv
        \Rotatebox@std
}

\def\Rotatebox@kv[#1]#2{%
    \@collectbox{\Grot@box@kv[#1]{#2}\BOXCONTENT}%
}

\def\Rotatebox@std#1{%
    \@collectbox{\Grot@box@std{#1}\BOXCONTENT}%
}

\newcommand*\Scalebox[1]{%
    \collectboxcheckenv{Scalebox}%
    \@ifnextchar[%
        {\Scale@box{#1}}%
        {\Scale@box{#1}[#1]}%
}

\def\Scale@box#1[#2]{%
    \@collectbox{\Gscale@box{#1}[#2]\BOXCONTENT}%
}

\newcommand*\Reflectbox{%
    \collectboxcheckenv{Reflectbox}%
    \Scale@box{-1}[1]%
}


\newcommand*\Resizebox{%
    \collectboxcheckenv{Resizebox}%
    \@ifstar
        {\@Resizebox\totalheight}%
        {\@Resizebox\height}%
}

\@namedef{Resizebox*}{%
    \collectboxcheckenv{Resizebox*}%
    \@Resizebox\totalheight
}

\def\@Resizebox#1#2#3{%
    \@collectbox{\Gscale@@box{#1}{#2}{#3}\BOXCONTENT}%
}


%%% dashbox
\RequirePackage{dashbox}

\newcommand*\Dbox{%
    \@collectbox{\dbox{\BOXCONTENT}}%
}


\newcommand*\Dashbox{%
    \@ifnextchar[%
        \@Dashbox
        \Dbox
}

\def\@Dashbox[#1]{%
    \@ifnextchar[%
        {\@iDashbox{#1}}%
        {\@iDashbox{#1}[c]}%
}

\def\@iDashbox#1[#2]{%
    \@collectbox{\dashbox[#1][#2]{\BOXCONTENT}}%
}


\newcommand*\Lbox{%
    \@ifnextchar[%
        \@Lbox
        {\@collectbox{\lbox{\BOXCONTENT}}}%
}

\def\@Lbox[#1]{%
    \@collectbox{\lbox[#1]{\BOXCONTENT}}%
}


\newcommand*\Dlbox{%
    \@ifnextchar[%
        \@Dlbox
        {\@collectbox*\dlbox}%
}

\def\@Dlbox[#1]{%
    \@collectbox{\dlbox[#1]{\BOXCONTENT}}%
}




